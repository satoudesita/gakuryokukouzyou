<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>芋虫ゲーム - 複数コース選択</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #87ceeb 0%, #30b1e4 100%);
      font-family: sans-serif;
      user-select: none;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #home, #game-container {
      width: 440px;
      padding: 20px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 0 20px rgba(236, 6, 6, 0.2);
    }
    #home {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    #home h1 {
      margin-bottom: 12px;
    }
    .course-btn {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background-color: #3b82f6;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      max-width: 320px;
    }
    .course-btn:hover {
      background-color: #2563eb;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(10, 40px);
      grid-template-rows: repeat(10, 40px);
      gap: 4px;
      background-color: #3ec9f34d;
      padding: 6px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .cell {
      width: 40px;
      height: 40px;
      position: relative;
      transition: background-color 0.2s ease;
    }
    .green {
      background-color: #4caf50;
      border-radius: 50%;
      box-shadow: inset 0 4px 6px #3b7a3b, 0 0 6px #3b7a3baa;
    }
    .green.head::before {
      content: '';
      position: absolute;
      top: 4px;
      left: 12px;
      width: 4px;
      height: 10px;
      background: #3b7a3b;
      border-radius: 2px;
      box-shadow: 12px 0 #3b7a3b;
    }
    .brown {
      background-color: #c2a669;
    }
    .red {
      background-color: #e53e3e;
      border-radius: 50%;
      box-shadow: inset 0 3px 5px #b23030, 0 0 8px #ff6060aa;
    }
    .goal {
      background-color: #3b82f6;
      border-radius: 10px;
      box-shadow: 0 0 8px #3b82f6aa;
    }
    #message {
      background: #28a745;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: bold;
      user-select: none;
      box-shadow: 0 0 10px #28a745aa;
      text-align: center;
      margin-bottom: 8px;
      display: none;
    }
    #back-btn {
      padding: 8px 20px;
      border-radius: 8px;
      border: none;
      background-color: #ef4444;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #back-btn:hover {
      background-color: #b91c1c;
    }

    .spike {
      background: repeating-linear-gradient(135deg, #ef4444 0 8px, #fff 8px 16px);
      border-radius: 6px;
      box-shadow: 0 0 8px #ef4444aa;
      position: relative;
    }
    .spike::after {
      content: "";
      position: absolute;
      left: 8px; right: 8px; top: 8px; bottom: 8px;
      border-radius: 4px;
      border: 2px solid #fff;
      pointer-events: none;
    }

    .course-btns {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }

    .stone {
      background: repeating-linear-gradient(45deg, #888 0 10px, #bbb 10px 20px);
      border-radius: 6px;
      box-shadow: 0 0 8px #8888;
      border: 2px solid #aaa;
    }
  </style>
</head>
<body>

<!-- コース選択ボタン部分 -->
<div id="home">
  <h1>芋虫ゲーム - コース選択</h1>
  <div class="course-btns">
    <button class="course-btn" data-course="0">1</button>
    <button class="course-btn" data-course="1">2</button>
    <button class="course-btn" data-course="2">3</button>
    <button class="course-btn" data-course="3">4</button>
    <button class="course-btn" data-course="4">5</button>
    <button class="course-btn" data-course="5">6</button>
    <button class="course-btn" data-course="6">7</button>
    <button class="course-btn" data-course="7">8</button>
    <button class="course-btn" data-course="8">9</button>
    <button class="course-btn" data-course="9">10</button>
  </div>
</div>

<div id="game-container" style="display:none;">
  <div id="message">クリアしました！おめでとう！</div>
  <div id="grid"></div>
  <button id="back-btn">コース選択に戻る</button>
</div>

<script>
  const courses = [
  // 1
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,1,0,0,0,0,0,0,0,0],
      [0,0,4,0,0,0,0,0,0,0],
      [0,0,0,1,0,0,0,0,0,0],
      [0,0,0,0,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,5,0,0],
      [0,0,0,2,1,1,1,1,0,1],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,4,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 2
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,1,1,1,1,1,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 3
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 4
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 5
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 6
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 7
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 8
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 9
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,0,0,0,0,0],
      [2,0,0,0,0,0,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 0 },
      { row: 9, col: 1 },
      { row: 9, col: 2 },
    ]
  },
  // 10
  {
    map: [
      [0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0],
      [1,1,1,1,1,2,0,0,0,0]
    ],
    startPositions: [
      { row: 9, col: 5 },
      { row: 9, col: 6 },
      { row: 9, col: 7 },
    ]
  }
];

  const rows = 10;
  const cols = 10;
  const home = document.getElementById("home");
  const gameContainer = document.getElementById("game-container");
  const grid = document.getElementById("grid");
  const message = document.getElementById("message");
  const backBtn = document.getElementById("back-btn");

  let cells = [];
  let positions = [];
  let hasRed = false;
  let isCleared = false;
  let currentMap = [];
  let gravityInterval;

  // グリッドを作成
  function createGrid() {
    grid.innerHTML = "";
    cells = [];
    for (let i = 0; i < rows * cols; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      grid.appendChild(cell);
      cells.push(cell);
    }
  }

  // 描画関数
  function drawBlock() {
    cells.forEach(cell => {
      cell.className = "cell";
    });

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const cell = cells[r * cols + c];
        if (currentMap[r][c] === 1) {
          cell.classList.add("brown");
        } else if (currentMap[r][c] === 2) {
          cell.classList.add("red");
        } else if (currentMap[r][c] === 3) {
          cell.classList.add("goal");
        } else if (currentMap[r][c] === 4) {
          cell.classList.add("spike");
        } else if (currentMap[r][c] === 5) {
          cell.classList.add("stone");
        }
      }
    }

    positions.forEach((pos, idx) => {
      const cell = cells[pos.row * cols + pos.col];
      cell.classList.add("green");
      if (idx === 0) {
        cell.classList.add("head");
      }
    });
  }

  function isBlocked(row, col, isHead) {
    if (row < 0 || row >= rows || col < 0 || col >= cols) return true;

    // 芋虫の体がいる場所は進めない
    if (positions.some(p => p.row === row && p.col === col)) return true;

    const cellType = currentMap[row][col];
    if (cellType === 1) return true; // 土

    if (cellType === 3) {
      if (!hasRed) return true; // リンゴ未取得時はゴールに入れない
      if (!isHead) return true; // 頭以外がゴールに当たるのもNG
    }

    return false;
  }

  function isRed(row, col) {
    return currentMap[row]?.[col] === 2;
  }

  // クリア判定（頭だけがゴールマス上か）
function checkClear() {
  if (!hasRed) return;

  const head = positions[0];
  if (currentMap[head.row][head.col] === 3 && !isCleared) {
    isCleared = true;
    clearInterval(gravityInterval); 
    message.style.display = "block";
  }
}

// --- 追加: トゲブロック判定とゲームオーバー処理 ---
function isSpike(row, col) {
  return currentMap[row]?.[col] === 4;
}

function gameOver() {
  clearInterval(gravityInterval);
  message.textContent = "ゲームオーバー！";
  message.style.background = "#ef4444";
  message.style.display = "block";
  isCleared = true;
}

// --- 追加: トゲ判定 ---
function checkSpike() {
  // 芋虫の全ての体パーツがトゲに触れていないか判定
  for (const pos of positions) {
    if (isSpike(pos.row, pos.col)) {
      gameOver();
      break;
    }
  }
}


  // ゲームの初期化
  function initGame(courseIndex) {
    clearInterval(gravityInterval);
    message.style.display = "none";
    isCleared = false;
    hasRed = false;
    const course = courses[courseIndex];
    currentMap = course.map.map(row => row.slice()); // コピー
    positions = course.startPositions.map(pos => ({ ...pos }));

    createGrid();
    drawBlock();

    gravityInterval = setInterval(() => {
      if (isCleared) return;

      const nextPositions = positions.map((pos, idx) => ({
        row: pos.row + 1,
        col: pos.col
      }));

      const blocked = nextPositions.some((pos, idx) => {
        return isBlocked(pos.row, pos.col, idx === 0);
      });

      if (!blocked) {
        positions = nextPositions;
        drawBlock();
      }
      checkRedEat();
      checkClear();
      checkSpike(); // ← 追加
    }, 80);
  }

  // 赤リンゴ取得判定
  function checkRedEat() {
    const head = positions[0];
    if (isRed(head.row, head.col)) {
      currentMap[head.row][head.col] = 0;
      hasRed = true;
      const tail = positions[positions.length - 1];
      positions.push({ row: tail.row, col: tail.col });
      drawBlock();
    }
  }

  // キー操作
  document.addEventListener("keydown", (e) => {
    if (gameContainer.style.display === "none") return; // ゲーム画面じゃなければ無視
    if (isCleared) return;

    const head = { ...positions[0] };
    let nextHead = { ...head };

    if (e.key === "ArrowRight") nextHead.col += 1;
    else if (e.key === "ArrowLeft") nextHead.col -= 1;
    else if (e.key === "ArrowDown") nextHead.row += 1;
    else if (e.key === "ArrowUp") nextHead.row -= 1;
    else return;

    if (positions.slice(1).some(p => p.row === nextHead.row && p.col === nextHead.col)) return;
    // 石を押す場合の判定
    if (currentMap[nextHead.row]?.[nextHead.col] === 5) {
      let dr = nextHead.row - head.row;
      let dc = nextHead.col - head.col;
      let nextStoneRow = nextHead.row + dr;
      let nextStoneCol = nextHead.col + dc;
      if (
        nextStoneRow >= 0 && nextStoneRow < rows &&
        nextStoneCol >= 0 && nextStoneCol < cols &&
        (currentMap[nextStoneRow][nextStoneCol] === 0 || currentMap[nextStoneRow][nextStoneCol] === 4)
      ) {
        // 石を押す
        currentMap[nextStoneRow][nextStoneCol] = 5;
        currentMap[nextHead.row][nextHead.col] = 0;
      } else {
        return;
      }
    } else if (isBlocked(nextHead.row, nextHead.col, true, e.key)) {
      return;
    }

    positions.unshift(nextHead);
    positions.pop();

    drawBlock();

    checkClear();
    checkSpike();
  });

  // 石ブロックの重力処理
function applyStoneGravity() {
  let moved = false;
  // 下から順に処理（石が連続している場合のため）
  for (let r = rows - 2; r >= 0; r--) {
    for (let c = 0; c < cols; c++) {
      if (currentMap[r][c] === 5) {
        // 石の下が空白 or トゲなら落下。ただし芋虫の体があれば落ちない
        const isBody = positions.some(p => p.row === r + 1 && p.col === c);
        if ((currentMap[r + 1][c] === 0 || currentMap[r + 1][c] === 4) && !isBody) {
          currentMap[r + 1][c] = 5;
          currentMap[r][c] = 0;
          moved = true;
        }
      }
    }
  }
  return moved;
}

// 重力処理に石の重力を追加
function gravityStep() {
  if (isCleared) return;

  applyStoneGravity();

  // 体の全パーツが下に進めるか判定
  const canFall = positions.every(pos => {
    const nextRow = pos.row + 1;
    // フィールド外は落ちない
    if (nextRow >= rows) return false;
    // 芋虫自身の体は無視してOK
    if (positions.some(p => p.row === nextRow && p.col === pos.col)) return true;
    // 下が空白・トゲ・石なら落ちてOK
    const cell = currentMap[nextRow][pos.col];
    return cell === 0 || cell === 4 || cell === 5;
  });

  if (canFall) {
    positions = positions.map(pos => ({
      row: pos.row + 1,
      col: pos.col
    }));
    drawBlock();
  }
  checkRedEat();
  checkClear();
  checkSpike();
}

function initGame(courseIndex) {
  clearInterval(gravityInterval);
  message.style.display = "none";
  isCleared = false;
  hasRed = false;
  const course = courses[courseIndex];
  currentMap = course.map.map(row => row.slice());
  positions = course.startPositions.map(pos => ({ ...pos }));

  createGrid();
  drawBlock();

  gravityInterval = setInterval(gravityStep, 80);
}

// コース選択ボタンのクリックイベント
document.querySelectorAll('.course-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const idx = Number(btn.getAttribute('data-course'));
    home.style.display = "none";
    gameContainer.style.display = "block";
    initGame(idx);
  });
});

// 戻るボタン
backBtn.addEventListener('click', () => {
  clearInterval(gravityInterval);
  gameContainer.style.display = "none";
  home.style.display = "flex";
});
</script>
</body>
</html>
